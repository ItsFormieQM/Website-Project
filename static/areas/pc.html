<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deltarune?</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:"DETERMINATION SANS", monospace; }
  body {
    display:flex; justify-content:center; align-items:center;
    height:100vh; background-color:black; overflow:hidden; position:relative;
  }
  .game-container {
    position:relative; width:1080px; height:720px; image-rendering:pixelated;
  }
  .background {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background-image:url('/static/backgrounds/krisRoom.png');
    background-size:contain; background-repeat:no-repeat; background-position:center;
    image-rendering:pixelated; z-index:0;
  }
  .player {
    position:absolute; width:28px; height:28px;
    background-image:url('/static/sprites/red.png');
    background-size:contain; background-repeat:no-repeat;
    image-rendering:pixelated; z-index:2;
  }
  .barrier {
    position:absolute; background-color:red;
    z-index:1;
  }
</style>
</head>
<body>
<div class="game-container" id="game-container">
  <div class="background"></div>
  <div class="player" id="player"></div>
</div>

<script src="/scripts/dialogue.js"></script>
<script src="/scripts/moveToRMHallway.js"></script>
<script>
/* ------------------------- CONSTANTS ------------------------- */
const LOGICAL_WIDTH = 320;
const LOGICAL_HEIGHT = 240;
const PLAYER_SIZE = 28;
const SCALE_X = 1080 / LOGICAL_WIDTH;
const SCALE_Y = 720 / LOGICAL_HEIGHT;

/* ------------------------- PLAYER ------------------------- */
let player = { x:158, y:144, speed:1 };
clearExternalBackground();

/* ------------------------- INPUT ------------------------- */
const keys = {};
window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

/* ------------------------- MUSIC ------------------------- */
let area = 1;
let isMusicPlaying = false;
let hasInteracted = false;

class bgm_mus {
  constructor() {
    this.dess = new Audio('/static/music/home.ogg');
    this.dess.volume = 1.0;
    this.dess.loop = true;
    
  }
  playKrisRoom() {
    if(area === 1 && !isMusicPlaying){
      this.dess.play().catch(()=>{});
      isMusicPlaying = true;
      
    }
  }

  stopMusic() {
    this.dess.pause();
    this.dess.currentTime = 0;
    isMusicPlaying = false;
  }
}
const musicPlayer = new bgm_mus();

/* ------------------------- BARRIERS ------------------------- */
const barriers = [
  {
    x:121, y:97, w:20, h:20, visible:true, triggerdialogue1:true,
  },
  {x:68, y:97, w:30, h:62, visible:true},
  {x:45, y:130, w:8, h:68, visible:false},
  {x:65, y:218, w:82, h:4, visible:false},
];

/* ------------------------- CREATE BARRIER DIVS ------------------------- */
const container = document.getElementById('game-container');
const playerDiv = document.getElementById('player');


barriers.forEach(b => {
  if(b.visible){
    const div = document.createElement('div');
    div.classList.add('barrier');
    div.style.left = `${b.x*SCALE_X}px`;
    div.style.top  = `${b.y*SCALE_Y}px`;
    div.style.width = `${b.w*SCALE_X}px`;
    div.style.height = `${b.h*SCALE_Y}px`;
    container.appendChild(div);
  }
  b.triggered = false;
});

/* ------------------------- COLLISION ------------------------- */
function checkCollision(px, py, pw, ph, barrier){
  return px < barrier.x + barrier.w &&
         px + pw > barrier.x &&
         py < barrier.y + barrier.h &&
         py + ph > barrier.y;
}

/* ------------------------- DIALOGUE SYSTEM ------------------------- */
let dialogueActive = false;
let dialogueQueue = [];
let currentLine = 0;

// Create dialogue box div
const dialogueBox = document.createElement('div');
dialogueBox.style.position = 'absolute';
dialogueBox.style.bottom = '10px';
dialogueBox.style.left = '50%';
dialogueBox.style.transform = 'translateX(-50%)';
dialogueBox.style.backgroundColor = 'rgba(0,0,0,0.8)';
dialogueBox.style.color = 'white';
dialogueBox.style.padding = '10px';
dialogueBox.style.fontFamily = '"DETERMINATION SANS", monospace';
dialogueBox.style.fontSize = '16px';
dialogueBox.style.border = '2px solid white';
dialogueBox.style.display = 'none';
container.appendChild(dialogueBox);


// Show dialogue lines
function showDialogue(lines, callback){
  dialogueQueue = lines;
  currentLine = 0;
  dialogueActive = true;
  dialogueBox.style.display = 'block';
  dialogueBox.textContent = dialogueQueue[currentLine];

  function nextLine(){
    if(keys['z'] && !zPressedLastFrame){
      currentLine++;
      if(currentLine < dialogueQueue.length){
        dialogueBox.textContent = dialogueQueue[currentLine];
      } else {
        dialogueBox.style.display = 'none';
        dialogueActive = false;
        callback();
      }
    }
  }

  dialogueNextLine = nextLine; // store so game loop can call it
}
let dialogueNextLine = null;

/* ------------------------- Z PRESS HANDLER ------------------------- */
let zPressedLastFrame = false;
function handleInteraction() {
  // Advance dialogue if active
  if(dialogueActive && dialogueNextLine){
    dialogueNextLine();
  }

  if(dialogueActive) return;

  // Check barrier triggers
  barriers.forEach(barrier => {
    if(barrier.triggerdialogue1 && !barrier.triggered){
      if(checkCollision(player.x, player.y, PLAYER_SIZE, PLAYER_SIZE, barrier)){
        if(keys['z'] && !zPressedLastFrame){
          barrier.triggered = true;
          showDialogue(barrier.dialogue, ()=>{});
        }
      }
    }
  });

  zPressedLastFrame = keys['z'];
}

/* ------------------------- PLAYER MOVEMENT ------------------------- */
function movePlayer(){
  let dx=0, dy=0;
  if(window.canMove) {
    if(keys['w']) dy-=player.speed;
  if(keys['s']) dy+=player.speed;
  if(keys['a']) dx-=player.speed;
  if(keys['d']) dx+=player.speed;
  }

  if(dx!==0 && dy!==0){
    const mag = Math.hypot(dx, dy);
    dx = dx/mag * player.speed;
    dy = dy/mag * player.speed;
  }

  let nextX = player.x + dx;
  let nextY = player.y + dy;

  if(!barriers.some(b=>checkCollision(nextX, player.y, PLAYER_SIZE, PLAYER_SIZE, b))) player.x = nextX;
  if(!barriers.some(b=>checkCollision(player.x, nextY, PLAYER_SIZE, PLAYER_SIZE, b))) player.y = nextY;

  player.x = Math.max(0, Math.min(LOGICAL_WIDTH-PLAYER_SIZE, player.x));
  player.y = Math.max(0, Math.min(LOGICAL_HEIGHT-PLAYER_SIZE, player.y));
}

/* ------------------------- GAME LOOP ------------------------- */
function gameLoop(){
  if(!hasInteracted && Object.values(keys).some(v=>v)){
    hasInteracted = true;
    musicPlayer.playKrisRoom();
  }

  movePlayer();
  handleInteraction();

  playerDiv.style.left = `${Math.round(player.x*SCALE_X)}px`;
  playerDiv.style.top  = `${Math.round(player.y*SCALE_Y)}px`;

  requestAnimationFrame(gameLoop);
}

gameLoop();

window.onload = function() {
    const navEntries = performance.getEntriesByType("navigation");
    if (navEntries.length > 0 && navEntries[0].type === "reload") {
        // Page was refreshed
        window.location.href = "/static/areas/pc.html"; // redirect on refresh
        playMenuMUS();
        isMusicPlaying = true;
    }
};

// Pure JS function to remove a background div added by another script
function clearExternalBackground() {
  // Select the first element with class 'background'
  const bg = document.querySelector('.background');
  if (bg) {
    bg.remove(); // removes it from the DOM
  }
}

clearExternalBackground();
setBackgroundImage('/static/backgrounds/krisHallway.png');
</script>
</body>
</html>
